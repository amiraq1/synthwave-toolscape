# AI Coding Guide

- **Stack & entry**: Vite + React 18 + TypeScript, React Router 6, TanStack Query, Tailwind/shadcn. App mounts in [src/main.tsx](src/main.tsx) and routes/lazy-loading live in [src/App.tsx](src/App.tsx) (all pages lazy, chat widget lazy but rendered globally).
- **Routing pattern**: Keep routes added in [src/App.tsx](src/App.tsx); scroll reset handled by [src/components/ScrollToTop.tsx](src/components/ScrollToTop.tsx). Add new routes above the `*` catch-all.
- **Data layer**: Supabase client is configured in [src/integrations/supabase/client.ts](src/integrations/supabase/client.ts) using `VITE_SUPABASE_URL` and `VITE_SUPABASE_PUBLISHABLE_KEY`. Alias `@` maps to `src` (see [vite.config.ts](vite.config.ts)).
- **Tools listing**: [src/hooks/useTools.ts](src/hooks/useTools.ts) drives infinite scrolling with `useInfiniteQuery`, pulls from `tools` table, sanitizes search (escapes `%`, `_`, `\`, trims to 100 chars), and orders featured first then newest. `Tool.id` is treated as string; convert IDs to numbers before querying when needed.
- **Hybrid search**: [src/hooks/useSemanticSearch.ts](src/hooks/useSemanticSearch.ts) calls Supabase Edge Function `search` for semantic results; `useHybridSearch` auto-enables when client results < threshold. Keep parity between client filtering and server embeddings.
- **Chat**: [src/hooks/useChat.ts](src/hooks/useChat.ts) invokes Supabase Edge Function `chat`, sends last 5 messages as history, and appends model replies. UI in [src/components/ChatWidget.tsx](src/components/ChatWidget.tsx).
- **Tool details**: [src/hooks/useTool.ts](src/hooks/useTool.ts) fetches a single tool via `tools` table (string ID parsed to int) and exposes a prefetch helper; use this on hover in cards to warm cache.
- **Reviews**: [src/hooks/useReviews.ts](src/hooks/useReviews.ts) uses RPC functions `get_public_reviews` and `get_tool_review_stats`; mutations invalidate `reviews`, `review-stats`, `user-review`, and `tool-ratings` query keys. Error handling already toasts localized messages—reuse patterns.
- **Home page UX**: [src/pages/Index.tsx](src/pages/Index.tsx) is RTL-first, switches between timeline and grid depending on search/filter, and gates Add Tool modal behind auth. Respect the accessibility skip link and structured data hooks when editing.
- **Auth**: [src/hooks/useAuth.ts](src/hooks/useAuth.ts) listens to Supabase auth changes, stores session in localStorage, and sets `RETURN_TO_KEY` for Google OAuth; the callback route `/auth/callback` should clear and navigate back. Prefer these helpers over direct Supabase calls.
- **Styling**: Tailwind with `cn` helper ([src/lib/utils.ts](src/lib/utils.ts)); design leans neon/gradient + RTL. Shadcn UI components live under `src/components/ui`.
- **Performance**: Vite config enables PWA (manifest rtl/ar), aggressive runtime caching for Supabase and fonts, manual Rollup chunking for core libs, and image optimization ([vite.config.ts](vite.config.ts)). Keep new assets PWA-friendly (add to `includeAssets` if necessary).
- **Scripts**: `npm run dev` (port 8080), `npm run build`, `npm run build:dev` (dev mode build), `npm run preview`, `npm run lint`. Use `pnpm`/`npm` consistently; lockfile is `bun.lockb` but project scripts expect Node/npm.
- **Environment**: Minimum required envs: `VITE_SUPABASE_URL`, `VITE_SUPABASE_PUBLISHABLE_KEY`. Edge functions expect Supabase service keys configured server-side; do not ship secrets to the client.
- **Data contracts**: `tools` rows include pricing, features, FAQs, alternatives, ratings, trending metrics; favor optional chaining and null checks. Reviews table accessed via RPC excludes `user_id`—keep PII out of the client.
- **Internationalization**: Text is Arabic-first; keep copy RTL-aware and avoid hardcoded LTR layouts. Badges/toasts already localized; maintain tone/emoji patterns.
- **SEO/structured data**: Use `useSEO` and `useStructuredData` hooks on new pages to set titles/OG/meta and JSON-LD; see [src/pages/Index.tsx](src/pages/Index.tsx) for usage.
- **File organization**: Pages under `src/pages`, shared UI in `src/components`, data utilities/hooks under `src/hooks` and `src/lib`, Supabase types in `src/integrations/supabase/types.ts`, edge function sources under `supabase/functions`.
- **Testing/demo scripts**: Repo includes `test-chat.ts`, `test-db.ts`, `test-taaft.ts` for quick integration checks; align new utilities with these patterns if extending CLI tooling.
- **When adding features**: Prefer TanStack Query for async state (set `staleTime`/`gcTime`), sanitize user input before Supabase filters, and route all DB access through `supabase` client or RPCs. Keep lazy loading for heavy components and preserve skeleton fallbacks.

If anything here seems off or incomplete, let me know what to clarify or expand.